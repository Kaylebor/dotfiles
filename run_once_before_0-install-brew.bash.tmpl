#!/usr/bin/env bash
{{- if (not (lookPath "brew")) }}
# Install Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
{{- end }}
# Install Homebrew packages
{{- template "brew_eval" . }}
brew bundle --file="{{ .chezmoi.sourceDir }}/dot_config/brewfile/Brewfile"
{{- if lookPath "atuin" }}
# Use atuin for history management
atuin login -u "{{ onepasswordRead "op://Private/Atuin/username" }}" -p "{{ onepasswordRead "op://Private/Atuin/password" }}" -k "{{ onepasswordRead "op://Private/Atuin/key" }}"
{{- end }}

{{- if (or (eq .chezmoi.os "darwin") (eq .chezmoi.os "linux")) }}
{{- if lookPath "flatpak" }}
if flatpak list | grep -q "io.neovim.nvim"; then
  plug_path="$HOME/.var/app/io.neovim.nvim/data/nvim/site/autoload/plug.vim"
else
  plug_path="${XDG_DATA_HOME:-$HOME/.local/share}/nvim/site/autoload/plug.vim"
fi
{{- else }}
plug_path="${XDG_DATA_HOME:-$HOME/.local/share}/nvim/site/autoload/plug.vim"
{{- end }}
{{- else if eq .chezmoi.os "windows" }}
plug_path="$HOME/AppData/Local/nvim/site/autoload/plug.vim"
{{- end }}
if [ ! -f "$plug_path" ]; then
  curl -fLo "$plug_path" --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  nvim --headless +PlugInstall +qall
fi
