{{- template "brew_eval" . }}

{{- if and (hasKey . "homebrewPaths") (hasKey . "brewBin") .brewBin (stat .brewBin) }}
# Install Homebrew Casks to specified directory
export HOMEBREW_CASK_OPTS="--appdir={{ .homebrewPaths.applicationsPath }}"
{{- end }}

## PATH
# Add each of the specified directories to PATH if they exist
{{- if stat .paths.localBin }}
PATH="$HOME/.local/bin:$PATH" # User-installed binaries
{{- end }}
{{- if stat .paths.mixEscripts }}
PATH="$HOME/.mix/escripts:$PATH" # Mix escripts (Elixir)
{{- end }}
{{- if stat .paths.bunBin }}
PATH="$HOME/.bun/bin:$PATH" # Bun JavaScript runtime
{{- end }}
{{- if stat .paths.denoBin }}
PATH="$HOME/.deno/bin:$PATH" # Deno JavaScript runtime
{{- end }}
{{- if stat .paths.rdBin }}
PATH="$HOME/.rd/bin:$PATH" # Rancher Desktop for Docker management
{{- end }}
{{- if stat .paths.yabridge }}
PATH="$HOME/.local/share/yabridge:$PATH" # Yabridge for VST plugins
{{- end }}
{{- $xdgDataHome := env "XDG_DATA_HOME" }}
{{- if not $xdgDataHome }}
{{-   $xdgDataHome = .paths.localShare }}
{{- end }}
{{- if stat (joinPath $xdgDataHome "google-cloud-sdk" "bin") }}
PATH="${XDG_DATA_HOME:-$HOME/.local/share}/google-cloud-sdk/bin:$PATH" # Google Cloud SDK
{{- end }}
{{- if stat (joinPath .chezmoi.homeDir "google-cloud-sdk" "bin") }}
PATH="$HOME/google-cloud-sdk/bin:$PATH"
{{- end }}
{{- if eq .chezmoi.os "darwin" }}
{{-   $brewPrefix := "" }}
{{-   if and (hasKey . "homebrewInstallType") (eq .homebrewInstallType "alternative") }}
{{-     if and (hasKey . "homebrewPaths") (stat .homebrewPaths.base) }}
{{-       $brewPrefix = .homebrewPaths.base }}
{{-     end }}
{{-   else }}
{{-     if stat "/opt/homebrew" }}
{{-       $brewPrefix = "/opt/homebrew" }}
{{-     else if stat "/usr/local/Homebrew" }}
{{-       $brewPrefix = "/usr/local" }}
{{-     end }}
{{-   end }}
{{-   if and $brewPrefix (stat (joinPath $brewPrefix "opt" "libpq" "bin")) }}
PATH="{{ $brewPrefix }}/opt/libpq/bin:$PATH" # PostgreSQL
{{-   end }}
{{-   if and $brewPrefix (stat (joinPath $brewPrefix "opt" "sqlite" "bin")) }}
PATH="{{ $brewPrefix }}/opt/sqlite/bin:$PATH" # Sqlite from Homebrew instead of MacOS built-in
{{-   end }}
{{- end }}
export PATH

# Common environment variables (locale, docker, man pager, ulimit)
{{ template "common_env.tmpl" (dict "shell" "zsh" "chezmoi" .chezmoi) }}

# Add XDG-compliant completion directory to fpath for all zsh instances
# This ensures tools like carapace and aider completions are found
fpath=(
    ${XDG_DATA_HOME:-$HOME/.local/share}/zsh/site-functions
    $fpath
)

# Add custom functions directory for autoload
fpath=(${ZDOTDIR:-$HOME/.config/zsh}/functions $fpath)

# Autoload custom functions
autoload -Uz ec ecc

{{- if eq .chezmoi.os "darwin" }}
# Reload SSH identities from macOS Keychain when shells start
if [ -z "${__SSH_KEYCHAIN_LOADED:-}" ]; then
{{-   if lookPath "ssh-add" }}
  if command -v ssh-add >/dev/null 2>&1; then
    ssh-add --apple-load-keychain >/dev/null 2>&1 || true
  fi
{{-   end }}
  export __SSH_KEYCHAIN_LOADED=1
fi

# Set up gcc paths for alternative Homebrew installations
export LANG=en_US.UTF-8

# Homebrew environment variables (pkg-config, LDFLAGS, etc.)
{{- $brewPrefix := "" }}
{{- if and (hasKey . "homebrewInstallType") (eq .homebrewInstallType "alternative") }}
{{-   if and (hasKey . "homebrewPaths") (stat .homebrewPaths.base) }}
{{-     $brewPrefix = .homebrewPaths.base }}
{{-   end }}
{{- else }}
{{-   if stat "/opt/homebrew" }}
{{-     $brewPrefix = "/opt/homebrew" }}
{{-   else if stat "/usr/local/Homebrew" }}
{{-     $brewPrefix = "/usr/local" }}
{{-   end }}
{{- end }}
{{- if $brewPrefix }}
{{ template "homebrew_env.tmpl" (dict "shell" "zsh" "brewPrefix" $brewPrefix) }}
{{- end }}
# Homebrew GCC environment variables
{{ template "homebrew_gcc_env.tmpl" (dict "shell" "zsh" "brewPrefix" $brewPrefix) }}
{{- end }}

{{- if eq .chezmoi.os "darwin" }}
# GNU utilities for macOS (replacing BSD equivalents)
{{- $brewPrefix := "" }}
{{- if and (hasKey . "homebrewInstallType") (eq .homebrewInstallType "alternative") }}
{{-   if and (hasKey . "homebrewPaths") (stat .homebrewPaths.base) }}
{{-     $brewPrefix = .homebrewPaths.base }}
{{-   end }}
{{- else }}
{{-   if stat "/opt/homebrew" }}
{{-     $brewPrefix = "/opt/homebrew" }}
{{-   else if stat "/usr/local/Homebrew" }}
{{-     $brewPrefix = "/usr/local" }}
{{-   end }}
{{- end }}
{{- if $brewPrefix }}
{{ template "gnu_utils.tmpl" (dict "shell" "zsh" "brewPrefix" $brewPrefix "chezmoi" .chezmoi) }}
{{- end }}
{{- end }}
