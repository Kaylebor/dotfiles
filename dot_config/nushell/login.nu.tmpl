# Nushell Login Shell Configuration
# This file is loaded when nushell is started as a login shell
# See https://www.nushell.sh/book/configuration.html

{{- if lookPath "mise" }}
# Ensure mise shims are available in login shells
let mise_config_dir = $nu.default-config-dir
let mise_shim_file = ($mise_config_dir | path join "mise-path.nu")
if (path exists $mise_shim_file) {
    source-env $mise_shim_file
}
{{- end }}

# Login shell specific environment variables
# These will be inherited by all subprocesses

# Language and locale settings
$env.LANG = "en_US.UTF-8"
$env.LC_ALL = "en_US.UTF-8"

{{- if eq .chezmoi.os "darwin" }}
# Homebrew environment variables (pkg-config, LDFLAGS, etc.)
{{- $brewPrefix := "" }}
{{- range $path := (list "/opt/homebrew" "/usr/local") }}
{{- if stat $path }}
{{- $brewPrefix = $path }}
{{- end }}
{{- end }}
{{- if and (hasKey . "homebrewPaths") (hasKey .homebrewPaths "base") (stat .homebrewPaths.base) }}
{{- $brewPrefix = .homebrewPaths.base }}
{{- end }}
{{- if $brewPrefix }}
{{ template "homebrew_env.tmpl" (dict "shell" "nushell" "brewPrefix" $brewPrefix) }}
{{ template "homebrew_gcc_env.tmpl" (dict "shell" "nushell" "brewPrefix" $brewPrefix) }}
{{- end }}
{{- end }}

# SSH Agent
{{- if eq .chezmoi.os "linux" }}
# Start SSH agent if not already running on Linux
if (not ($env | get SSH_AUTH_SOCK? | is-empty)) {
    # SSH agent is already running
} else {
    # Start a new SSH agent
    let ssh_agent_output = (ssh-agent -s | lines)
    for line in $ssh_agent_output {
        if ($line | str contains "SSH_AUTH_SOCK=") {
            let parts = ($line | split row ';' | get 0 | split row '=')
            $env.SSH_AUTH_SOCK = ($parts | get 1)
        } else if ($line | str contains "SSH_AGENT_PID=") {
            let parts = ($line | split row ';' | get 0 | split row '=')
            $env.SSH_AGENT_PID = ($parts | get 1)
        }
    }
}
{{- end }}

# 1Password SSH Agent
{{- if not .skip1Password }}
{{- if eq .chezmoi.os "darwin" }}
$env.SSH_AUTH_SOCK = "{{ .chezmoi.homeDir }}/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
{{- else if eq .chezmoi.os "linux" }}
$env.SSH_AUTH_SOCK = "{{ .chezmoi.homeDir }}/.1password/agent.sock"
{{- end }}
{{- end }}

{{- if eq .chezmoi.os "darwin" }}
if (($env.__SSH_KEYCHAIN_LOADED? | default "") | is-empty) {
    if (which ssh-add | length) > 0 {
        try { ssh-add --apple-load-keychain | ignore } catch { }
    }
    $env.__SSH_KEYCHAIN_LOADED = "1"
}
{{- end }}

# GPG Configuration
{{- if lookPath "gpg" }}
$env.GPG_TTY = (tty)
{{- end }}

# PATH Management
# Add each of the specified directories to PATH if they exist
{{- if stat .paths.localBin }}
$env.PATH = ($env.PATH | prepend $"($env.HOME)/.local/bin")
{{- end }}
{{- if stat .paths.mixEscripts }}
$env.PATH = ($env.PATH | prepend $"($env.HOME)/.mix/escripts")
{{- end }}
{{- if stat .paths.bunBin }}
$env.PATH = ($env.PATH | prepend $"($env.HOME)/.bun/bin")
{{- end }}
{{- if stat .paths.denoBin }}
$env.PATH = ($env.PATH | prepend $"($env.HOME)/.deno/bin")
{{- end }}
{{- if stat .paths.rdBin }}
$env.PATH = ($env.PATH | prepend $"($env.HOME)/.rd/bin")
{{- end }}
{{- if stat .paths.yabridge }}
$env.PATH = ($env.PATH | prepend $"($env.HOME)/.local/share/yabridge")
{{- end }}
{{- $xdgDataHome := env "XDG_DATA_HOME" }}
{{- if not $xdgDataHome }}
{{-   $xdgDataHome = .paths.localShare }}
{{- end }}
{{- if stat (joinPath $xdgDataHome "google-cloud-sdk" "bin") }}
$env.PATH = ($env.PATH | prepend $"($env.XDG_DATA_HOME? | default $"($env.HOME)/.local/share")/google-cloud-sdk/bin")
{{- end }}
{{- if stat (joinPath .chezmoi.homeDir "google-cloud-sdk" "bin") }}
$env.PATH = ($env.PATH | prepend $"($env.HOME)/google-cloud-sdk/bin")
{{- end }}

{{- if eq .chezmoi.os "darwin" }}
{{-   $brewPrefix := "" }}
{{-   if and (hasKey . "homebrewInstallType") (eq .homebrewInstallType "alternative") }}
{{-     if and (hasKey . "homebrewPaths") (stat .homebrewPaths.base) }}
{{-       $brewPrefix = .homebrewPaths.base }}
{{-     end }}
{{-   else }}
{{-     if stat "/opt/homebrew" }}
{{-       $brewPrefix = "/opt/homebrew" }}
{{-     else if stat "/usr/local/Homebrew" }}
{{-       $brewPrefix = "/usr/local" }}
{{-     end }}
{{-   end }}
{{-   if and $brewPrefix (stat (joinPath $brewPrefix "opt" "libpq" "bin")) }}
$env.PATH = ($env.PATH | prepend $"{{ $brewPrefix }}/opt/libpq/bin")
{{-   end }}
{{- end }}
{{- if and (eq .chezmoi.os "darwin") (hasKey . "brewBin") .brewBin }}
$env.PATH = ($env.PATH | prepend $"({{ .brewBin }} --prefix sqlite | str trim)/bin")
{{- end }}

# Development environment variables
{{- if eq .chezmoi.os "darwin" }}
# macOS specific development settings
$env.MACOSX_DEPLOYMENT_TARGET = "11.0"
{{- end }}

# Terminal capabilities
if ($env.TERM? | is-empty) or ($env.TERM == "dumb") {
    $env.TERM = "xterm-256color"
}

# Homebrew environment variables (pkg-config, LDFLAGS, etc.)
{{- if eq .chezmoi.os "darwin" }}
{{-   $brewPrefix := "" }}
{{-   if and (hasKey . "homebrewInstallType") (eq .homebrewInstallType "alternative") }}
{{-     if and (hasKey . "homebrewPaths") (stat .homebrewPaths.base) }}
{{-       $brewPrefix = .homebrewPaths.base }}
{{-     end }}
{{-   else }}
{{-     if stat "/opt/homebrew" }}
{{-       $brewPrefix = "/opt/homebrew" }}
{{-     else if stat "/usr/local/Homebrew" }}
{{-       $brewPrefix = "/usr/local" }}
{{-     end }}
{{-   end }}
{{-   if $brewPrefix }}
{{ template "homebrew_env.tmpl" (dict "shell" "nushell" "brewPrefix" $brewPrefix) }}
{{-   end }}
{{- end }}

# Machine-specific login configuration
{{- $localLogin := joinPath .paths.configDir "nushell/login.local.nu" }}
{{- if stat $localLogin }}
source "{{ $localLogin }}"
{{- else }}
# Note: To add local config, create {{ $localLogin }}
{{- end }}
