# Nushell Configuration
# See https://www.nushell.sh/book/configuration.html

{{- if lookPath "mise" }}
# Load mise shims and activation generated via mise activate nu
let mise_config_dir = $nu.default-config-dir
let mise_shim_file = ($mise_config_dir | path join "mise-path.nu")
if (path exists $mise_shim_file) {
    source-env $mise_shim_file
}
let mise_module = ($mise_config_dir | path join "mise.nu")
if (path exists $mise_module) {
    use $mise_module *
}
{{- end }}

# Early PATH setup for Homebrew (macOS)
{{- if eq .chezmoi.os "darwin" }}
{{- if stat (joinPath .chezmoi.homeDir ".homebrew" "bin" "brew") }}
$env.PATH = ($env.PATH | split row (char esep) | prepend ["{{ .chezmoi.homeDir }}/.homebrew/sbin", "{{ .chezmoi.homeDir }}/.homebrew/bin"] | uniq)
{{- else if stat (joinPath .chezmoi.homeDir "homebrew" "bin" "brew") }}
$env.PATH = ($env.PATH | split row (char esep) | prepend ["{{ .chezmoi.homeDir }}/homebrew/sbin", "{{ .chezmoi.homeDir }}/homebrew/bin"] | uniq)
{{- else if stat "/opt/homebrew/bin/brew" }}
$env.PATH = ($env.PATH | split row (char esep) | prepend ["/opt/homebrew/sbin", "/opt/homebrew/bin"] | uniq)
{{- else if stat "/usr/local/bin/brew" }}
$env.PATH = ($env.PATH | split row (char esep) | prepend ["/usr/local/sbin", "/usr/local/bin"] | uniq)
{{- end }}
{{- end }}

# Core environment variables
# Set EDITOR with emacsclient preference and fallback
{{- if lookPath "emacsclient" }}
{{- $fallbackEditor := "" }}
{{- $tuiEditors := list "hx" "nvim" "vim" "vi" }}
{{- range $editor := $tuiEditors }}
{{- if and (not $fallbackEditor) (lookPath $editor) }}
{{- $fallbackEditor = $editor }}
{{- end }}
{{- end }}
{{- if $fallbackEditor }}
$env.EDITOR = "emacsclient -t --alternate-editor='{{ $fallbackEditor }}'"
{{- else }}
$env.EDITOR = "emacsclient -t"
{{- end }}
{{- else }}
{{- $tuiEditors := list "hx" "nvim" "vim" "vi" }}
{{- range $editor := $tuiEditors }}
{{- if lookPath $editor }}
$env.EDITOR = "{{ $editor }}"
{{- break }}
{{- end }}
{{- end }}
{{- end }}

# Set VISUAL with GUI preference and fallback
{{- if lookPath "emacsclient" }}
{{- $fallbackEditor := "" }}
{{- if lookPath "zed" }}
{{- $fallbackEditor = "zed -w" }}
{{- else }}
{{- $visualEditors := list "hx" "nvim" "vim" "vi" }}
{{- range $editor := $visualEditors }}
{{- if and (not $fallbackEditor) (lookPath $editor) }}
{{- $fallbackEditor = $editor }}
{{- end }}
{{- end }}
{{- end }}
$env.VISUAL = "emacsclient -c{{ if $fallbackEditor }} --alternate-editor='{{ $fallbackEditor }}'{{ end }}"
{{- else if lookPath "zed" }}
$env.VISUAL = "zed -w"
{{- else }}
$env.VISUAL = $env.EDITOR
{{- end }}
$env.PAGER = "{{ if lookPath "bat" }}bat --style=plain{{ else if lookPath "less" }}less -R{{ else }}more{{ end }}"
$env.LANG = "en_US.UTF-8"
$env.LC_ALL = "en_US.UTF-8"
$env.DOCKER_BUILDKIT = "1"

# Path configuration
$env.PATH = ($env.PATH | split row (char esep) | prepend [
    {{- if stat .paths.localBin }}
    "{{ .paths.localBin }}"
    {{- end }}
    {{- if stat .paths.binDir }}
    "{{ .paths.binDir }}"
    {{- end }}
    {{- if stat (joinPath .paths.localShare "google-cloud-sdk" "bin") }}
    "{{ .paths.localShare }}/google-cloud-sdk/bin"
    {{- end }}
    {{- if stat .paths.yabridge }}
    "{{ .paths.yabridge }}"
    {{- end }}
    {{- if stat .paths.rdBin }}
    "{{ .paths.rdBin }}"
    {{- end }}
    {{- if stat .paths.denoBin }}
    "{{ .paths.denoBin }}"
    {{- end }}
    {{- if stat .paths.bunBin }}
    "{{ .paths.bunBin }}"
    {{- end }}
    {{- if stat .paths.mixEscripts }}
    "{{ .paths.mixEscripts }}"
    {{- end }}
    {{- if lookPath "mise" }}
    "{{ .chezmoi.homeDir }}/.local/share/mise/shims"
    {{- end }}
] | uniq)

{{- if eq .chezmoi.os "darwin" }}
# Add GNU utils to PATH on macOS
{{- $gnuUtils := list "coreutils" "findutils" "gnu-sed" "gawk" "grep" }}
{{- range $util := $gnuUtils }}
{{- $gnuBinPath := printf "%s/opt/%s/libexec/gnubin" (or (and (stat (joinPath $.chezmoi.homeDir ".homebrew")) (joinPath $.chezmoi.homeDir ".homebrew")) (and (stat (joinPath $.chezmoi.homeDir "homebrew")) (joinPath $.chezmoi.homeDir "homebrew")) (and (stat "/opt/homebrew") "/opt/homebrew") "/usr/local") $util }}
{{- if stat $gnuBinPath }}
$env.PATH = ($env.PATH | split row (char esep) | prepend "{{ $gnuBinPath }}" | uniq)
{{- end }}
{{- end }}
{{- end }}

# 1Password SSH Agent
{{- if not .skip1Password }}
{{- if eq .chezmoi.os "darwin" }}
$env.SSH_AUTH_SOCK = "{{ .chezmoi.homeDir }}/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
{{- else if eq .chezmoi.os "linux" }}
$env.SSH_AUTH_SOCK = "{{ .chezmoi.homeDir }}/.1password/agent.sock"
{{- end }}
{{- end }}

{{- if lookPath "gpg" }}
$env.GPG_TTY = (tty)
{{- end }}

# Git and PSQL editors (prefer TUI for these)
$env.GIT_EDITOR = $env.EDITOR
$env.PSQL_EDITOR = $env.EDITOR

{{- if lookPath "bat" }}
# Bat as man pager
$env.MANPAGER = "sh -c 'col -bx | bat -l man -p'"
{{- end }}

{{- if and (eq .chezmoi.os "darwin") (hasKey . "homebrewInstallType") (eq .homebrewInstallType "alternative") (hasKey .homebrewPaths "applicationsPath") }}
# Homebrew Cask installation directory for MDM-restricted systems
$env.HOMEBREW_CASK_OPTS = "--appdir={{ .homebrewPaths.applicationsPath }}"
{{- else if and (eq .chezmoi.os "darwin") (hasKey .homebrewPaths "applicationsPath") }}
# Homebrew Cask options (standard Homebrew)
$env.HOMEBREW_CASK_OPTS = "--appdir={{ .homebrewPaths.applicationsPath }}"
{{- end }}

{{- if and (hasKey .homebrewPaths "base") (stat (joinPath .homebrewPaths.base "opt" "gcc")) }}
# Homebrew GCC environment variables (conditionally set if gcc is installed)
{{ template "homebrew_gcc_env.tmpl" (dict "shell" "nushell" "brewPrefix" .homebrewPaths.base) }}
{{- end }}

# Carapace bridges for additional shell completions
{{- if lookPath "carapace" }}
$env.CARAPACE_BRIDGES = 'zsh,fish,bash'
{{- end }}

{{- if and .useLlamaSwap .enableLlamaSwapEnv }}
# Configure qwen-code for llama-swap (only when explicitly enabled)
$env.OPENAI_BASE_URL = "{{ .llamaSwapApiBase }}"
$env.OPENAI_API_KEY = "dummy"
$env.OPENAI_MODEL = "qwen3coder-a3b-q4-16l-256k-kq8fa"
{{- end }}

# Nushell Config
$env.config = {
    show_banner: false
    edit_mode: vi
    
    ls: {
        use_ls_colors: true
        clickable_links: true
    }
    
    table: {
        mode: rounded
        index_mode: always
        show_empty: true
    }
    
    history: {
        max_size: 100_000
        sync_on_enter: true
        file_format: "sqlite"
    }
    
    completions: {
        case_sensitive: false
        quick: true
        partial: true
        algorithm: "fuzzy"
        external: {
            enable: true
            max_results: 100
            completer: null
        }
    }
    
    cursor_shape: {
        vi_insert: line
        vi_normal: block
    }
    
    shell_integration: {
        osc2: true
        osc7: true
        osc8: true
        osc133: true
        osc633: true
    }
    
    buffer_editor: $env.EDITOR
    error_style: "fancy"
    render_right_prompt_on_last_line: false
    
    keybindings: [
        {
            name: completion_menu
            modifier: none
            keycode: tab
            mode: [emacs vi_normal vi_insert]
            event: {
                until: [
                    { send: menu name: completion_menu }
                    { send: menunext }
                    { edit: complete }
                ]
            }
        }
        {
            name: completion_previous_menu
            modifier: shift
            keycode: backtab
            mode: [emacs, vi_normal, vi_insert]
            event: { send: menuprevious }
        }
        {
            name: history_menu
            modifier: control
            keycode: char_r
            mode: [emacs, vi_insert, vi_normal]
            event: { send: menu name: history_menu }
        }
    ]
}

# Load Carapace completions (generated by run_before script)
{{- $carapaceInit := joinPath .paths.cacheDir "carapace/init.nu" }}
{{- if and (lookPath "carapace") (stat $carapaceInit) }}
source "{{ $carapaceInit }}"
{{- end }}

# Core aliases
alias la = ls -la
alias ll = ls -l

{{- if lookPath "eza" }}
alias ls = eza --icons=auto --git
alias la = eza -la --icons=auto --git  
alias ll = eza -l --icons=auto --git
alias tree = eza --tree --icons=auto
{{- end }}

{{- if lookPath "bat" }}
alias cat = bat
{{- end }}

{{- if lookPath "difft" }}
alias diff = difft
{{- end }}

# Utility aliases
alias q = exit
alias ":q" = exit

# Clipboard alias
{{- if lookPath "pbcopy" }}
alias cb = pbcopy
{{- else if lookPath "xclip" }}
alias cb = xclip -selection clipboard
{{- else if lookPath "clipboard" }}
alias cb = clipboard
{{- end }}

{{- if lookPath "emacsclient" }}
alias ec = emacsclient -nw
alias ecc = emacsclient -c -n
{{- end }}

# Utility functions
def rscp [source: path, destination: path] {
    rsync -avhzP --stats $source $destination
}

{{- if lookPath "bunx" }}
def ccusage [...args] {
    bunx ccusage ...$args
}
{{- end }}

# Television (tv) integration
{{- if lookPath "tv" }}
def --env tcd [] {
    let result = (tv)
    if ($result | is-not-empty) {
        cd $result
    }
}

$env.config = ($env.config | upsert keybindings ($env.config.keybindings | append {
    name: television_cd
    modifier: alt
    keycode: char_c
    mode: [emacs, vi_normal, vi_insert]
    event: { send: executehostcommand cmd: "tcd" }
}))
{{- end }}

# Load custom scripts from nushell config directory
{{- $gitShortcuts := joinPath .paths.nushellScripts "git-shortcuts.nu" }}
{{- if stat $gitShortcuts }}
source "{{ $gitShortcuts }}"
{{- end }}

{{- $ezaAliases := joinPath .paths.nushellScripts "eza-aliases.nu" }}
{{- if stat $ezaAliases }}
source "{{ $ezaAliases }}"
{{- end }}

# Load Catppuccin theme (downloaded via .chezmoiexternal.toml)
{{- $catppuccinTheme := joinPath .paths.nushellThemes "catppuccin_frappe.nu" }}
{{- if stat $catppuccinTheme }}
source "{{ $catppuccinTheme }}"
{{- end }}
