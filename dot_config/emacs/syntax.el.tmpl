;; -*- lexical-binding: t; -*-

;; Automatic tree-sitter mode management
(use-package treesit-auto
  :ensure t
  :custom
  (treesit-auto-install 'prompt)  ; Prompt before installing missing grammars
  :config
  (treesit-auto-add-to-auto-mode-alist 'all)
  (global-treesit-auto-mode))

(use-package emacs-lisp-mode
  :ensure nil
  :delight
  :mode ("\\.el\\'" . emacs-lisp-mode))

(use-package sh-mode
  :ensure nil
  :delight
  :mode ("\\.fish\\(rc\\)?\\'" . sh-mode))

(use-package sql-mode
  :ensure nil
  :delight
  :mode ("\\.sql\\'" . sql-mode)
  :hook (sql-mode . lsp-deferred))

;; PostgreSQL wire protocol library (lambda password support is upstream)
(use-package pg
  :ensure t)

;; PostgreSQL database browser and editor
(use-package pgmacs
  :ensure (:host github :repo "emarsden/pgmacs"))

;; PostgreSQL execution mode with auth-source integration
(use-package pgx-mode
  :ensure (:host github 
                 :repo "Kaylebor/pgx-mode"
                 :files ("*.el"))  ; Include all .el files
  :after (sql pg)  ; Let elpaca handle dependencies from Package-Requires
  :hook (sql-mode . pgx-mode)
  :config
  ;; Enable pgmacs display if available
  (when (and (featurep 'pgmacs) (featurep 'pgx-mode-pgmacs))
    (pgx-enable-pgmacs-display))
  ;; Load device-specific PostgreSQL connections
  (let ((sql-config-file "~/.config/emacs/sql-connections.el"))
    (when (file-exists-p sql-config-file)
      (load sql-config-file))))

;; Configure sqls LSP for completions (localhost only)
;; Note: sqls reads connections from .sqls/config.json in project root

(use-package dbml-mode
  :ensure t
  :delight
  :mode ("\\.dbml\\'" . dbml-mode))


(use-package javascript-ts-mode
  :ensure nil
  :delight
  :mode (("\\.jsx\\'" . js-jsx-mode)))  ; jsx still needs explicit mode

(use-package elixir-ts-mode
  :ensure nil
  :delight
  :mode ("\\.\\(ex\\|exs\\|eex\\|leex\\|heex\\)\\'" . elixir-ts-mode))

(use-package gdscript-mode :ensure (:host github :repo "godotengine/emacs-gdscript-mode") :delight :mode ("\\.gd\\'" . gdscript-ts-mode))

;; Linting - only activate in programming modes
(use-package flycheck :ensure t
  :delight
  :hook (prog-mode . flycheck-mode)  ; Lazy load for programming modes only
  :config
  ;; Disable Ruby checkers that overlap with Ruby LSP
  (setq-default flycheck-disabled-checkers '(ruby-rubocop ruby-standard)))

;; Show flycheck errors inline in the buffer
(use-package flycheck-inline :ensure t
  :after flycheck
  :hook (flycheck-mode . flycheck-inline-mode))

;; Navigate flycheck errors with consult
(use-package consult-flycheck :ensure t
  :after (consult flycheck))

;; Automatic code formatting on save
(use-package apheleia :ensure t
  :config
  ;; Hide from modeline by setting lighter to empty
  (setq apheleia-mode-lighter "")
  ;; Enable globally - formats on save without interrupting
  (apheleia-global-mode +1)
  ;; Ensure formatters use mise-managed tools
  ;; Apheleia will automatically find these in PATH via mise
  ;; No additional configuration needed for standard formatters:
  ;; - prettier (JS/TS/HTML/CSS/JSON/YAML)
  ;; - black/ruff (Python)
  ;; - gofmt/goimports (Go)
  ;; - mix format (Elixir)
  ;; - rubocop/standardrb (Ruby)
  ;; - rustfmt (Rust)
  ;; - shfmt (Shell)
  )

;; LSP support
(use-package lsp-mode :ensure t
  :delight
  :defer t  ; Don't load until a supported mode activates
  :custom
  (setopt lsp-keymap-prefix "C-c l")
  (lsp-keep-workspace-alive nil) ;; close LSP servers after last buffer is closed
  (lsp-ruby-lsp-use-bundler nil) ;; use global ruby-lsp with composed bundle
  (lsp-completion-provider :none) ;; Use corfu instead of company-mode
  ;; Monorepo support: disable auto-guessing to get prompts for correct project roots
  (lsp-auto-guess-root nil) ;; Let LSP prompt for project root in monorepos
  :hook
  (ruby-ts-mode . lsp)
  (html-ts-mode . lsp)
  (typescript-ts-mode . lsp)
  (tsx-ts-mode . lsp)
  (javascript-ts-mode . lsp)
  (js-jsx-mode . lsp)
  (go-ts-mode . lsp)
  (lua-ts-mode . lsp)
  (elixir-ts-mode . lsp)
  (gdscript-ts-mode . lsp)
  (rust-ts-mode . lsp)
  (lsp-mode . lsp-enable-which-key-integration)
  (lsp-mode . lsp-headerline-breadcrumb-mode)
  :config
  ;; Enable breadcrumb in header line with icons
  (setq lsp-headerline-breadcrumb-enable t)
  (setq lsp-headerline-breadcrumb-icons-enable t)
  
  ;; Configure signature help to use posframe (child frame at point)
  (setq lsp-signature-auto-activate t)  ; Auto-activate signature help
  (setq lsp-signature-render-documentation t)  ; Include documentation
  
  ;; Use posframe for signature display (floating child frame)
  ;; This requires the posframe package which we already have
  (setq lsp-signature-function 'lsp-signature-posframe)
  
  ;; Configure eldoc to show signatures in echo area instead
  (setq lsp-eldoc-enable-hover t)              ; Enable hover info in eldoc
  (setq lsp-eldoc-render-all nil)              ; Don't render everything, just essentials
  
  ;; Suppress company-mode warnings since we're using corfu
  (setq lsp-warn-no-matched-clients nil)

  ;; Monorepo workflow: LSP will prompt you to select the correct project root
  ;; the first time you open a file in each subproject. Your choices are saved
  ;; in ~/.emacs.d/.lsp-session-v1 and remembered across Emacs sessions.
  ;; Commands: M-x lsp-workspace-folders-{add,remove} to manage workspace folders
  
  ;; Configure go.mod files - disable LSP for them as gopls doesn't support them well
  (add-to-list 'lsp-language-id-configuration '(go-mod-mode . "go.mod"))
  (add-hook 'go-mod-ts-mode-hook (lambda () (lsp-mode -1)))
  
  ;; Configure all LSP servers to use mise for consistent environment management
  ;; This ensures they get the correct versions and environment variables from mise
  
  ;; Go LSP (gopls) - uses separate path and args variables
  (with-eval-after-load 'lsp-go
    (setq lsp-go-gopls-server-path "mise")
    (setq lsp-go-gopls-server-args '("exec" "--" "gopls" "-remote=auto")))
  
  ;; TypeScript/JavaScript LSP - uses path and args pattern
  (with-eval-after-load 'lsp-javascript
    (setq lsp-clients-typescript-tls-path "mise")
    (setq lsp-clients-typescript-server-args '("exec" "--" "typescript-language-server" "--stdio")))
  
  ;; Angular language server - let lsp-angular auto-detect with mise
  (setq lsp-clients-angular-node-get-prefix-command 
        "mise exec -- sh -c 'dirname $(dirname $(which node))'")
  (setq lsp-clients-angular-language-server-command nil)
  
  ;; Rust analyzer
  (setq lsp-rust-analyzer-server-command '("mise" "exec" "--" "rust-analyzer"))
  
  ;; Re-register HTML/CSS/JSON servers to use mise exec for consistent environment
  (with-eval-after-load 'lsp-html
    (lsp-register-client
     (make-lsp-client 
      :new-connection (lsp-stdio-connection
                       '("mise" "exec" "--" "vscode-html-language-server" "--stdio"))
      :activation-fn (lsp-activate-on "html")
      :priority -4
      :completion-in-comments? t
      :server-id 'html-ls
      :initialization-options (lambda ()
                                (list :dataPaths lsp-html-custom-data))
      :async-request-handlers (ht ("html/customDataContent" #'lsp-html--get-content))
      :initialized-fn (lambda (w)
                        (with-lsp-workspace w
                                            (lsp--set-configuration
                                             (lsp-configuration-section "html")))))))
  
  (with-eval-after-load 'lsp-css
    (lsp-register-client
     (make-lsp-client
      :new-connection (lsp-stdio-connection
                       '("mise" "exec" "--" "vscode-css-language-server" "--stdio"))
      :activation-fn (lsp-activate-on "css" "scss" "sass" "less")
      :priority -1
      :action-handlers (lsp-ht ("_css.applyCodeAction" #'lsp-css--apply-code-action))
      :server-id 'css-ls)))
  
  (with-eval-after-load 'lsp-json
    (lsp-register-client
     (make-lsp-client
      :new-connection (lsp-stdio-connection
                       '("mise" "exec" "--" "vscode-json-language-server" "--stdio"))
      :activation-fn (lsp-activate-on "json" "jsonc")
      :server-id 'json-ls
      :priority 0
      :multi-root t
      :completion-in-comments? t
      :initialization-options lsp-json--extra-init-params
      :async-request-handlers (ht ("vscode/content" #'lsp-json--get-content))
      :initialized-fn (lambda (w)
                        (with-lsp-workspace w
                                            (lsp--set-configuration
                                             (ht-merge (lsp-configuration-section "json")
                                                       (lsp-configuration-section "http")))
                                            (lsp-notify "json/schemaAssociations" lsp-json--schema-associations))))))

  ;; Lua language server via mise
  (lsp-register-client
   (make-lsp-client
    :new-connection (lsp-stdio-connection '("mise" "exec" "--" "lua-language-server"))
    :activation-fn (lsp-activate-on "lua")
    :server-id 'lua-ls
    :priority 1))
  
  ;; Disable TypeProf and default ruby-lsp to avoid conflicts
  (add-to-list 'lsp-disabled-clients 'typeprof-ls)
  (add-to-list 'lsp-disabled-clients 'ruby-lsp-ls)
  ;; Register custom ruby-lsp client with launcher for dependency handling
  (lsp-register-client
   (make-lsp-client
    :new-connection (lsp-stdio-connection 
                     (lambda () 
                       ;; Find the actual Rails root directory for monorepos
                       (let* ((file-dir (if buffer-file-name 
                                            (file-name-directory buffer-file-name)
                                          default-directory))
                              (rails-root (or (locate-dominating-file file-dir "Gemfile")
                                              (locate-dominating-file file-dir "config/application.rb")
                                              file-dir)))
                         (let ((default-directory rails-root))
                           (list (my-mise-which "ruby-lsp") "--use-launcher")))))
    :activation-fn (lsp-activate-on "ruby")
    :priority 10
    :server-id 'ruby-lsp-mise))
  
  
  (defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
    "Prepend emacs-lsp-booster command to lsp CMD, with mise support."
    (let ((orig-result (funcall old-fn cmd test?)))
      (if (and (not test?)                             ;; for check lsp-server-present?
               (not (file-remote-p default-directory)) ;; see lsp-resolve-final-command, it would add extra shell wrapper
               lsp-use-plists
               (not (functionp 'json-rpc-connection))  ;; native json-rpc
               (executable-find "emacs-lsp-booster"))
          (progn
            ;; If command starts with mise exec, we need to insert lsp-booster after mise exec
            (if (and (listp orig-result)
                     (>= (length orig-result) 3)
                     (string= (car orig-result) "mise")
                     (string= (cadr orig-result) "exec"))
                ;; mise exec -- <cmd> becomes mise exec -- emacs-lsp-booster -- <cmd>
                (append '("mise" "exec" "--" "emacs-lsp-booster" "--disable-bytecode" "--")
                        (nthcdr 3 orig-result))
              ;; Regular command: prepend emacs-lsp-booster
              (progn
                (when-let* ((command-from-exec-path (executable-find (car orig-result))))  ;; resolve command from exec-path (in case not found in $PATH)
                  (setcar orig-result command-from-exec-path))
                (message "Using emacs-lsp-booster for %s!" orig-result)
                (append '("emacs-lsp-booster" "--disable-bytecode" "--") orig-result))))
        orig-result)))
  (advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command))

;; Use Stylua for Lua formatting if available (managed by mise)
(with-eval-after-load 'apheleia
  (add-to-list 'apheleia-mode-alist '(lua-ts-mode . stylua)))

(use-package lsp-treemacs :ensure t
  :defer t
  :after lsp-mode
  :custom
  (lsp-treemacs-theme "nerd-icons"))

(use-package lsp-ui :ensure t
  :defer t
  :after lsp-mode
  :custom
  ;; Configure doc to use floating popup style
  (lsp-ui-doc-enable t)                 ; Enable documentation
  (lsp-ui-doc-position 'at-point)       ; Show at point instead of top/bottom
  (lsp-ui-doc-show-with-cursor t)       ; Show on cursor hover
  (lsp-ui-doc-show-with-mouse t)        ; Show on mouse hover
  (lsp-ui-doc-delay 1.0)                ; Longer delay to be less intrusive
  
  ;; Force child frame for proper floating behavior
  (lsp-ui-doc-use-childframe t)         ; Use child frame for better positioning
  (lsp-ui-doc-use-webkit nil)           ; Don't use webkit renderer
  (lsp-ui-doc-max-width 80)             ; Maximum width
  (lsp-ui-doc-max-height 20)            ; Maximum height
  
  ;; Sideline (inline hints, but not intrusive)
  (lsp-ui-sideline-enable t)            ; Enable inline hints
  (lsp-ui-sideline-show-hover nil)      ; Don't show hover info in sideline
  (lsp-ui-sideline-show-diagnostics t)  ; Show diagnostics
  (lsp-ui-sideline-show-code-actions t) ; Show code actions
  (lsp-ui-sideline-delay 1.0)           ; Delay before showing
  
  ;; Peek configuration
  (lsp-ui-peek-enable t)                ; Enable peek feature
  (lsp-ui-peek-show-directory t)
  
  :config
  ;; Manual keybinding to show doc on demand
  (define-key lsp-ui-mode-map (kbd "C-c h") #'lsp-ui-doc-glance)
  (define-key lsp-ui-mode-map (kbd "C-c H") #'lsp-ui-doc-focus-frame))

;; Corfu for in-buffer completion (works great with LSP)
(use-package corfu :ensure t
  :custom
  (corfu-cycle t)                    ;; Enable cycling for `corfu-next/previous'
  (corfu-auto t)                     ;; Enable auto completion
  (corfu-auto-delay 0.3)             ;; Delay before auto completion
  (corfu-auto-prefix 2)              ;; Minimum prefix length for auto completion
  (corfu-separator ?\s)              ;; Orderless field separator
  (corfu-quit-at-boundary 'separator) ;; Quit at completion boundary
  (corfu-quit-no-match 'separator)   ;; Quit when no match with separator
  (corfu-preview-current 'insert)    ;; Preview current candidate on insert
  (corfu-preselect 'prompt)          ;; Preselect the prompt
  (corfu-on-exact-match nil)         ;; Don't auto-select exact matches
  (corfu-scroll-margin 5)            ;; Use scroll margin
  :init
  (global-corfu-mode)
  
  ;; Enable Corfu in minibuffer for eval-expression etc.
  (defun corfu-enable-in-minibuffer ()
    "Enable Corfu in the minibuffer if `completion-at-point' is bound."
    (when (where-is-internal #'completion-at-point (list (current-local-map)))
      (setq-local corfu-auto nil)  ; Disable auto completion
      (corfu-mode 1)))
  (add-hook 'minibuffer-setup-hook #'corfu-enable-in-minibuffer))

;; Add extensions
(use-package corfu-popupinfo :ensure nil
  :after corfu
  :hook (corfu-mode . corfu-popupinfo-mode)
  :custom
  (corfu-popupinfo-delay '(0.5 . 0.1))   ; Quick popup after selection
  (corfu-popupinfo-hide nil)             ; Don't hide automatically
  (corfu-popupinfo-max-height 20)        ; Maximum height for docs
  (corfu-popupinfo-max-width 80)         ; Maximum width for docs
  :config
  (corfu-popupinfo-mode)
  ;; Use M-d to manually toggle documentation during completion
  (define-key corfu-map (kbd "M-d") #'corfu-popupinfo-toggle)
  ;; M-n/M-p to scroll the documentation
  (define-key corfu-map (kbd "M-n") #'corfu-popupinfo-scroll-up)
  (define-key corfu-map (kbd "M-p") #'corfu-popupinfo-scroll-down))

;; Corfu terminal support
(use-package corfu-terminal :ensure t
  :if (not (display-graphic-p))
  :config
  (corfu-terminal-mode +1))

;; Icons in completion
(use-package kind-icon :ensure t
  :after corfu
  :custom
  (kind-icon-default-face 'corfu-default) ; Use corfu face as background
  (kind-icon-use-icons t)
  (kind-icon-blend-background t)
  :config
  (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))

;; Cape completion extensions
(use-package cape :ensure t
  :init
  ;; Add to the global default value of `completion-at-point-functions' which is
  ;; used by `completion-at-point'.  The order of the functions matters, the
  ;; first function returning a result wins.  Note that the list of buffer-local
  ;; completion functions takes precedence over the global list.
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-elisp-block)
  ;; cape-keyword for programming modes
  (add-hook 'prog-mode-hook
            (lambda ()
              (add-to-list 'completion-at-point-functions #'cape-keyword t))))

;; DAP debugging - only loads when needed
(use-package dap-mode :ensure t
  :defer t
  :hook
  ((lsp-mode . dap-mode)
   (lsp-mode . dap-ui-mode)))

;; Better projectile integration for Rails - only in Rails projects
(use-package projectile-rails :ensure t
  :defer t
  :after projectile
  :hook (projectile-mode . projectile-rails-on))

;; Load chezmoi template support (composite grammars for .tmpl files)
(load-file (expand-file-name "chezmoi-templates.el" user-emacs-directory))
