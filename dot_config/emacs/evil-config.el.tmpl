;; -*- lexical-binding: t; -*-
;; Evil modal editing configuration

(setopt evil-want-keybinding nil)

;; (use-package hydra :ensure t)  ; Disabled - not used anywhere, potential cause of freeze

(use-package undo-fu :ensure t)

(use-package evil :ensure t
  :delight
  :custom
  (evil-want-integration t)
  (evil-undo-system 'undo-fu)
  :init
  (evil-mode 1))

(use-package evil-collection :ensure t
  :delight evil-collection-unimpaired-mode
  :init
  (evil-collection-init))

;; treemacs-evil integration
(use-package treemacs-evil :ensure t
  :after (treemacs evil))

;; Evil keybindings
(with-eval-after-load 'evil
  ;; Replace M-: with pp-eval-expression
  (keymap-set evil-normal-state-map "M-:" #'pp-eval-expression)
  (keymap-set evil-normal-state-map "z a" #'treesit-fold-toggle)
  (keymap-set evil-normal-state-map "g l g" #'aidermacs-transient-menu)
  (keymap-set evil-normal-state-map "g l l" #'gptel-menu)
  (keymap-set evil-normal-state-map "g l s" #'gptel-send)
  (keymap-set evil-normal-state-map "g l a" #'gptel-add)
  (keymap-set evil-normal-state-map "g l f" #'gptel-add-file)
  (keymap-set evil-normal-state-map "g l d" #'gptel-multimodal-debug)
  (keymap-set evil-normal-state-map "g l p" #'gptel-quick-preset)
  (keymap-set evil-normal-state-map "M-?" #'which-key-show-top-level)

  ;; Avy navigation
  (keymap-set evil-normal-state-map "g s" #'avy-goto-char-timer)
  (keymap-set evil-visual-state-map "g s" #'avy-goto-char-timer)

  ;; Claude Code IDE bindings
  (keymap-set evil-normal-state-map "g l c" #'claude-code-ide-menu)
  (keymap-set evil-normal-state-map "g l C" #'claude-code-ide)
  (keymap-set evil-normal-state-map "g l r" #'claude-code-ide-resume)
  (keymap-set evil-normal-state-map "g l b" #'claude-code-ide-switch-to-buffer)
  (keymap-set evil-normal-state-map "g l q" #'claude-code-ide-stop)
  (keymap-set evil-normal-state-map "g l w" #'claude-code-ide-toggle-window)

  ;; Visual mode binding for sending selection to Claude
  (keymap-set evil-visual-state-map "g l i" #'claude-code-ide-insert-at-mentioned))

;; Claude Code IDE evil-mode vterm integration - DISABLED FOR DEBUGGING
;; Make C-c C-c send escape to Claude (for canceling operations)
;; This overrides the default vterm C-c C-c (which sends C-c)
;; (with-eval-after-load 'vterm
;;   (define-key vterm-mode-map (kbd "C-c C-c") #'claude-code-ide-send-escape))

(provide 'evil-config)