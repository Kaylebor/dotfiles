# AGENTS.md

Guidance for automated coding agents working inside this chezmoi-managed dotfiles repo.

## Core Workflows
- Always edit sources under `~/.local/share/chezmoi` (this repo) rather than generated files in `$HOME`.
- Use `chezmoi diff` to preview and `chezmoi apply` to deploy changes after validating.
- Prefer `apply_patch` for surgical edits; large autogenerated files (e.g., formatter output) can instead be replaced wholesale.
- Before running commands or tests, confirm the active OS with `chezmoi data | jq '.chezmoi.os'`. This repo serves both macOS and Arch/Linux machines, so keep platform conditionals in mind.

## apply_patch Notes
- Path resolution is relative to the current working directory passed with each command; prefer absolute paths (e.g. `/Users/...`) or repo-relative paths to avoid editing the wrong file.
- A user can interrupt `apply_patch`. When that happens it may surface as a generic failure (often “No such file or directory”); consider explicit user cancellation as a root cause before retrying.
- The preview shows only the immediate hunk, not the full file context. If the user seems confused, summarize where the change sits within the surrounding template so expectations stay aligned.

## Chezmoi Reference
- Context7 library ID for official documentation: `/twpayne/chezmoi`.
- Helpful commands:
  - `chezmoi data` – inspect available template variables.
  - `chezmoi execute-template <file>` – render a template for verification.
  - `chezmoi add --template <path>` – convert new files into templates when customization is required.
- Template primitives used in this repo:
  - `.chezmoi.os` / `.chezmoi.osRelease` for platform-specific conditionals.
  - `lookPath` and `stat` helpers to guard optional dependencies.
  - Shared partials in `.chezmoitemplates/` for reusable snippets.

## OS-Specific Files
- macOS-only assets live under `Library/` and are gated with `{{ if eq .chezmoi.os "darwin" }}` blocks plus matching entries in `.chezmoiignore`.
- Linux-only artifacts (Hyprland, systemd, etc.) are ignored automatically on other platforms via the same template pattern.

## SSH Keychain Reloading (macOS)
- Login shells (.profile, .zprofile, fish login, Nushell login) guard `ssh-add --apple-load-keychain` behind the `__SSH_KEYCHAIN_LOADED` environment variable so the call runs at most once per login chain.
- When you touch shell templates, keep that pattern intact and ensure macOS checks stay wrapped in `{{ if eq .chezmoi.os "darwin" }}` blocks.
