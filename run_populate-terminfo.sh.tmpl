#!/bin/bash
{{- if eq .chezmoi.os "darwin" }}
# Populate ~/.terminfo with ALL available terminal entries for Emacs daemon compatibility
# Runs on script changes to keep terminfo up to date

set -euo pipefail

# Ensure brew is initialized (for finding ncurses and other brew paths)
{{- template "brew_eval" . }}

TERMINFO_DIR="$HOME/.terminfo"
mkdir -p "$TERMINFO_DIR"

# Find the best tic command (prefer Homebrew ncurses)
TIC_CMD="tic"
{{- if and (hasKey . "homebrewPaths") (stat (joinPath .homebrewPaths.base "opt" "ncurses" "bin" "tic")) }}
if [[ -x "{{ .homebrewPaths.base }}/opt/ncurses/bin/tic" ]]; then
    TIC_CMD="{{ .homebrewPaths.base }}/opt/ncurses/bin/tic"
fi
{{- end }}

# Get all terminfo search paths from the system (excluding ~/.terminfo itself)
INFO_PATHS=()
while IFS= read -r path; do
    if [[ -d "$path" && "$path" != "$TERMINFO_DIR" ]]; then
        INFO_PATHS+=("$path")
    fi
done < <(infocmp -D 2>/dev/null)

# Create temp files for set operations
COMPILED_TERMS_FILE=$(mktemp)
SYSTEM_TERMS_FILE=$(mktemp)
MISSING_TERMS_FILE=$(mktemp)
trap "rm -f '$COMPILED_TERMS_FILE' '$SYSTEM_TERMS_FILE' '$MISSING_TERMS_FILE'" EXIT

# Build sorted list of already-compiled terminfos (use sed for fast basename extraction)
# Include both files and symlinks
find "$TERMINFO_DIR" \( -type f -o -type l \) 2>/dev/null | sed 's|.*/||' | sort -u > "$COMPILED_TERMS_FILE"

# Build sorted list of all system terminfos (use sed for fast basename extraction)
for info_path in "${INFO_PATHS[@]}"; do
    find "$info_path" \( -type f -o -type l \) 2>/dev/null
done | sed 's|.*/||' | sort -u > "$SYSTEM_TERMS_FILE"

# Find terminfos that need compilation (in system but not in compiled)
comm -23 "$SYSTEM_TERMS_FILE" "$COMPILED_TERMS_FILE" > "$MISSING_TERMS_FILE"

# Count missing entries
missing_count=$(wc -l < "$MISSING_TERMS_FILE" | tr -d ' ')
if [[ "$missing_count" -eq 0 ]]; then
    echo "~/.terminfo is up to date ($(wc -l < "$COMPILED_TERMS_FILE" | tr -d ' ') entries)"
    exit 0
fi

echo "Compiling $missing_count missing terminfo entries..."

# Compile missing terminfos
compiled=0
while IFS= read -r term; do
    [[ -z "$term" ]] && continue
    # Try to compile (only call infocmp once, use here-string instead of echo pipe)
    if terminfo_data=$(infocmp "$term" 2>/dev/null); then
        if "$TIC_CMD" -x -o "$TERMINFO_DIR" - <<< "$terminfo_data" 2>/dev/null; then
            ((compiled++)) || true
        fi
    fi
done < "$MISSING_TERMS_FILE"

echo "Compiled $compiled terminfo entries"
echo "~/.terminfo now has $(find "$TERMINFO_DIR" \( -type f -o -type l \) 2>/dev/null | wc -l | tr -d ' ') entries"
{{- else }}
# No-op on non-macOS systems (terminfo compilation not needed)
exit 0
{{- end }}