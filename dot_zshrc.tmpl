#!/usr/bin/env zsh

# Claude Code Detection and Environment Setup
# Claude Code sets CLAUDECODE=1 but doesn't source .zprofile
# We need to ensure mise is properly initialized for Claude Code
if [[ -n "$CLAUDECODE" ]]; then
    # Running in Claude Code - ensure mise is fully activated
    # Source .zprofile functionality since Claude Code doesn't source it
    if [[ -z "$__MISE_ACTIVATED" ]]; then
        eval "$(mise activate zsh)"
        export __MISE_ACTIVATED=1
    fi
fi

# Ensure mise is activated for interactive shells
if [[ -z "$__MISE_ACTIVATED" ]]; then
    eval "$(mise activate zsh)"
    export __MISE_ACTIVATED=1
fi


## HISTORY
export HISTFILE=~/.zsh_history
export HISTSIZE=500000
export SAVEHIST=500000
setopt EXTENDED_HISTORY          # Write the history file in the ":start:elapsed;command" format.
setopt INC_APPEND_HISTORY        # Write to the history file immediately, not when the shell exits.
setopt SHARE_HISTORY             # Share history between all sessions.
setopt HIST_FIND_NO_DUPS         # Do not display a line previously found.
setopt HIST_SAVE_NO_DUPS         # Don't write duplicate entries in the history file.
setopt HIST_REDUCE_BLANKS        # Remove superfluous blanks before recording entry.

## EARLY SETUP
# Load antidote plugin manager early (it will handle compinit via ez-compinit)
{{- $antidoteFiles := list }}
{{- if eq .chezmoi.os "darwin" }}
{{-   $brewPrefix := "" }}
{{-   if and (hasKey . "homebrewInstallType") (eq .homebrewInstallType "alternative") }}
{{-     if and (hasKey . "homebrewPaths") (stat .homebrewPaths.base) }}
{{-       $brewPrefix = .homebrewPaths.base }}
{{-     end }}
{{-   else }}
{{-     if stat "/opt/homebrew" }}
{{-       $brewPrefix = "/opt/homebrew" }}
{{-     else if stat "/usr/local/Homebrew" }}
{{-       $brewPrefix = "/usr/local" }}
{{-     end }}
{{-   end }}
{{-   if $brewPrefix }}
{{-     $antidoteFiles = append $antidoteFiles (joinPath $brewPrefix "opt" "antidote" "share" "antidote" "antidote.zsh") }}
{{-   end }}
{{- end }}
{{- $antidoteFiles = append $antidoteFiles "/usr/share/zsh-antidote/antidote.zsh" }}
{{- range $antidoteFile := $antidoteFiles }}
{{-   if stat $antidoteFile }}
source "{{ $antidoteFile }}"
# initialize plugins statically with ${ZDOTDIR:-~}/.zsh_plugins.txt
antidote load
{{-     break }}
{{-   end }}
{{- end }}

## COMPLETIONS
# Set completion styles
zstyle ':completion:*' menu yes select
zstyle ':completion:*' format $'\e[2;37mCompleting %d\e[m'

{{- if lookPath "carapace" }}
# Load carapace completions
# It includes completions for: aws, gcloud, docker, git, kubectl, terraform, and more
export CARAPACE_BRIDGES='zsh,fish,bash'
source <(carapace _carapace zsh)
{{- end }}

# Note: compinit is already handled by the ez-compinit plugin loaded via antidote

{{- if lookPath "tv" }}
# Integrate Television (after compinit is available)
eval "$(tv init zsh)"
{{- end }}

{{- if lookPath "op" }}
# Load op completions
source <(op completion zsh)
{{- end }}

## Envs

{{- if lookPath "bat" }}
# Bat as man pager
export MANPAGER="sh -c 'sed -u -e \"s/\\x1B\[[0-9;]*m//g; s/.\\x08//g\" | bat -p -lman'"
{{- end }}


{{- if stat (joinPath .paths.configDir "op" "plugins.sh") }}
source {{ .paths.configDir }}/op/plugins.sh
{{- end }}

# Emacs vterm helper function
vterm_printf() {
    if [ -n "$TMUX" ] \
        && { [ "${TERM%%-*}" = "tmux" ] || [ "${TERM%%-*}" = "screen" ]; }; then
        # Tell tmux to pass the escape sequences through
        printf "\ePtmux;\e\e]%s\007\e\\" "$1"
    elif [ "${TERM%%-*}" = "screen" ]; then
        # GNU screen (screen, screen-256color, screen-256color-bce)
        printf "\eP\e]%s\007\e\\" "$1"
    else
        printf "\e]%s\e\\" "$1"
    fi
}

{{- if and .useLlamaSwap .enableLlamaSwapEnv }}
# Configure qwen-code for llama-swap (only when explicitly enabled)
export OPENAI_BASE_URL="{{ .llamaSwapApiBase }}"
export OPENAI_API_KEY="dummy"
export OPENAI_MODEL="qwen3coder-a3b-q4-16l-256k-kq8fa"
{{- end }}

# Set up aliases
[[ $- == *i* ]] && source $HOME/.config/zsh/aliases.zsh

{{- if stat (joinPath .paths.configDir "zsh" ".zshrc.local") }}
# Per-machine configuration
source {{ .paths.configDir }}/zsh/.zshrc.local
{{- end }}

# Set EDITOR and VISUAL with emacsclient preference and fallback
{{- if lookPath "emacsclient" }}
{{- $tuiFallback := "" }}
{{- $tuiEditors := list "hx" "nvim" "vim" "vi" }}
{{- range $editor := $tuiEditors }}
{{- if and (not $tuiFallback) (lookPath $editor) }}
{{- $tuiFallback = $editor }}
{{- end }}
{{- end }}
{{- if $tuiFallback }}
export EDITOR="emacsclient -t --alternate-editor='{{ $tuiFallback }}'"
{{- else }}
export EDITOR="emacsclient -t"
{{- end }}

{{- $visualFallback := "" }}
{{- if lookPath "zed" }}
{{- $visualFallback = "zed -w" }}
{{- else }}
{{- $visualEditors := list "hx" "nvim" "vim" "vi" }}
{{- range $editor := $visualEditors }}
{{- if and (not $visualFallback) (lookPath $editor) }}
{{- $visualFallback = $editor }}
{{- end }}
{{- end }}
{{- end }}
{{- if $visualFallback }}
export VISUAL="emacsclient -c --alternate-editor='{{ $visualFallback }}'"
{{- else }}
export VISUAL="emacsclient -c"
{{- end }}

{{- else }}
{{- $tuiEditors := list "hx" "nvim" "vim" "vi" }}
{{- range $editor := $tuiEditors }}
{{- if lookPath $editor }}
export EDITOR="{{ $editor }}"
{{- break }}
{{- end }}
{{- end }}

{{- if lookPath "zed" }}
export VISUAL="zed -w"
{{- else }}
{{- $tuiEditors := list "hx" "nvim" "vim" "vi" }}
{{- range $editor := $tuiEditors }}
{{- if lookPath $editor }}
export VISUAL="{{ $editor }}"
{{- break }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}

export GIT_EDITOR="$EDITOR"
export PSQL_EDITOR="$EDITOR"
